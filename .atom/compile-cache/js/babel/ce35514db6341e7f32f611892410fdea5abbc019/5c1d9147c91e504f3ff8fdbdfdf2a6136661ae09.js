Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.mainMessageOfError = mainMessageOfError;
exports.mainLocOfError = mainLocOfError;
exports.mergedMessagesOfError = mergedMessagesOfError;
exports.prettyPrintError = prettyPrintError;

// Note: the following code is based on
// https://github.com/facebook/flow/blob/v0.47.0/tsrc/flowResult.js
// and adjusted to output nicely formatted markdown.

var _util = require('util');

var regexMarkdownChars = /[*#/()[\]<>_]/g;

function fileUrl(_ref) {
  var source = _ref.source;
  var start = _ref.start;

  // build a link that can be opened by the linter ui.
  // e.g. atom://linter?file=<path>&row=<number>&column=<number>
  var params = ['file=' + encodeURIComponent(source)];
  if (start.line > 0) {
    params.push('row=' + (start.line - 1));
    if (start.column > 0) {
      params.push('column=' + (start.column - 1));
    }
  }
  return 'atom://linter?' + params.join('&');
}
function linterLink(loc, text) {
  return '[' + text + '](' + fileUrl(loc) + ')';
}
function fileLink(loc) {
  return linterLink(loc, atom.project.relativize(loc.source));
}
function lineLink(loc) {
  return linterLink(loc, loc.start.line.toString());
}

function mainMessageOfError(error) {
  return error.operation || error.message[0];
}

function mainLocOfError(error) {
  return mainMessageOfError(error).loc;
}

function getExtraMessages(extra) {
  if (extra) {
    var messages = extra.reduce(function (acc, current) {
      var childrenMessages = getExtraMessages(current.children);
      return acc.concat(current.message, childrenMessages);
    }, []);
    messages.forEach(function (message) {
      var msg = message;
      msg.indent = (msg.indent || 0) + 2;
    });
    return messages;
  }
  return [];
}

function getTraceReasons(trace) {
  if (trace != null && trace.length > 0) {
    return [{ descr: 'Trace:', type: 'Blame' }].concat(trace);
  }
  return [];
}

function mkComment(descr) {
  return { descr: descr, type: 'Comment' };
}

function getOpReason(op) {
  if (op) {
    return [op, mkComment('Error:')];
  }
  return [];
}

function getHeader(mainLoc, kind, level) {
  var line = -1;
  var filename = '';
  if (mainLoc) {
    var source = mainLoc.source;
    var start = mainLoc.start;

    line = start.line;
    if (source) {
      filename = fileLink(mainLoc);
    }
  }
  if (!filename) {
    filename = (0, _util.format)('%s:%d', '[No file]', line);
  }

  var prefix = '';
  if (kind === 'internal' && level === 'error') {
    prefix = 'Internal error (see logs):\n';
  } else if (mainLoc && mainLoc.type === 'LibFile') {
    if (kind === 'parse' && level === 'error') {
      prefix = 'Library parse error:\n';
    } else if (kind === 'infer') {
      prefix = 'Library type error:\n';
    }
  }

  return [mkComment((0, _util.format)('%s%s', prefix, filename))];
}

function prettyPrintMessage(mainFile, _ref2) {
  var context = _ref2.context;
  var descr = _ref2.descr;
  var loc = _ref2.loc;
  var indent = _ref2.indent;

  var indentation = ' '.repeat(indent || 0);
  if (loc) {
    var startCol = loc.start.column - 1;
    var contextStr = indentation;
    if (context !== null && typeof context === 'string') {
      // On Windows this might have \r
      var ctx = context.trimRight();
      // Replace tabs with spaces
      ctx = ctx.replace(/\t/g, ' ');
      // escape certain chars that serve a purpose in markdown
      ctx = ctx.replace(regexMarkdownChars, '\\$&');

      var line = loc.start.line;

      var prefix = line < 100 ? ' '.repeat(3 - line.toString().length) : '';

      var padding = Array((prefix + line + ': ').length + 1).join(' ');
      if (ctx.length > startCol) {
        padding += ctx.substr(0, startCol).replace(/[^\t ]/g, ' ');
      }

      var underlineSize = line === loc.end.line ? Math.max(1, loc.end.column - startCol) : 1;
      var underline = '^'.repeat(underlineSize);

      contextStr = (0, _util.format)('%s%s%s: %s\n%s%s%s ', indentation, prefix, lineLink(loc), ctx, indentation, padding, underline);
    }
    var seeAnotherFile = loc.source === mainFile ? '' : (0, _util.format)('. See%s: %s', loc.type === 'LibFile' ? ' lib' : '', fileLink(loc));
    return (0, _util.format)('%s%s%s', contextStr, descr, seeAnotherFile);
  }
  return indentation + descr;
}

function mergedMessagesOfError(error) {
  var level = error.level;
  var kind = error.kind;
  var message = error.message;
  var operation = error.operation;
  var trace = error.trace;
  var extra = error.extra;

  var mainLoc = mainLocOfError(error);
  var messages = [].concat(getHeader(mainLoc, kind, level), getOpReason(operation), message, getExtraMessages(extra), getTraceReasons(trace));
  // Merge comments into blames
  return messages.reduce(function (acc, msg) {
    var descr = msg.descr;
    var loc = msg.loc;
    var type = msg.type;

    if (loc || acc.length === 0 || type === 'Blame') {
      acc.push(msg);
    } else if (descr !== 'Error:') {
      var prev = acc[acc.length - 1];
      prev.descr = prev.descr === '' ? descr : (0, _util.format)('%s. %s', prev.descr, descr);
    }
    return acc;
  }, []);
}

function prettyPrintError(error) {
  var mainLoc = mainLocOfError(error);
  var mainFile = mainLoc && mainLoc.source || '[No file]';
  var messages = mergedMessagesOfError(error);
  return '<div style="white-space: pre-wrap">' + messages.map(function (msg) {
    return prettyPrintMessage(mainFile, msg);
  }).join('\n') + '</div>';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy90bGFuZGF1L2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL2Zsb3ctaWRlL2xpYi9oZWxwZXJzLWxpbnRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7b0JBTXVCLE1BQU07O0FBRzdCLElBQU0sa0JBQWtCLEdBQUcsZ0JBQWdCLENBQUE7O0FBRTNDLFNBQVMsT0FBTyxDQUFDLElBQTJCLEVBQVU7TUFBbkMsTUFBTSxHQUFSLElBQTJCLENBQXpCLE1BQU07TUFBRSxLQUFLLEdBQWYsSUFBMkIsQ0FBakIsS0FBSzs7OztBQUc5QixNQUFNLE1BQU0sR0FBRyxDQUFDLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0FBQ3JELE1BQUksS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUU7QUFDbEIsVUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUEsQUFBQyxDQUFDLENBQUE7QUFDdEMsUUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUNwQixZQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQSxBQUFDLENBQUMsQ0FBQTtLQUM1QztHQUNGO0FBQ0QsU0FBTyxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0NBQzNDO0FBQ0QsU0FBUyxVQUFVLENBQUMsR0FBYSxFQUFFLElBQVksRUFBRTtBQUMvQyxTQUFPLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUE7Q0FDOUM7QUFDRCxTQUFTLFFBQVEsQ0FBQyxHQUFhLEVBQVU7QUFDdkMsU0FBTyxVQUFVLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMs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QUFBO0FBQ2hDLFVBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssS0FBSyxFQUFFLEdBQUcsS0FBSyxHQUFHLGtCQUFPLFFBQVEsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFBO0tBQzdFO0FBQ0QsV0FBTyxHQUFHLENBQUE7R0FDWCxFQUFFLEVBQUUsQ0FBQyxDQUFBO0NBQ1A7O0FBRU0sU0FBUyxnQkFBZ0IsQ0FBQyxLQUFrQixFQUFVO0FBQzNELE1BQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNyQyxNQUFNLFFBQVEsR0FBRyxBQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxJQUFLLFdBQVcsQ0FBQTtBQUMzRCxNQUFNLFFBQVEsR0FBRyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUM3QyxTQUFPLHFDQUFxQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBQSxHQUFHO1dBQUksa0JBQWtCLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQztHQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFBO0NBQzVIIiwiZmlsZSI6Ii9Vc2Vycy90bGFuZGF1L2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL2Zsb3ctaWRlL2xpYi9oZWxwZXJzLWxpbnRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbi8vIE5vdGU6IHRoZSBmb2xsb3dpbmcgY29kZSBpcyBiYXNlZCBvblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zsb3cvYmxvYi92MC40Ny4wL3RzcmMvZmxvd1Jlc3VsdC5qc1xuLy8gYW5kIGFkanVzdGVkIHRvIG91dHB1dCBuaWNlbHkgZm9ybWF0dGVkIG1hcmtkb3duLlxuXG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICd1dGlsJ1xuaW1wb3J0IHR5cGUgeyBTdGF0dXNFcnJvciwgU3RhdHVzRXh0cmEsIFN0YXR1c01lc3NhZ2UsIExvY2F0aW9uIH0gZnJvbSAnLi90eXBlcydcblxuY29uc3QgcmVnZXhNYXJrZG93bkNoYXJzID0gL1sqIy8oKVtcXF08Pl9dL2dcblxuZnVuY3Rpb24gZmlsZVVybCh7IHNvdXJjZSwgc3RhcnQgfTogTG9jYXRpb24pOiBzdHJpbmcge1xuICAvLyBidWlsZCBhIGxpbmsgdGhhdCBjYW4gYmUgb3BlbmVkIGJ5IHRoZSBsaW50ZXIgdWkuXG4gIC8vIGUuZy4gYXRvbTovL2xpbnRlcj9maWxlPTxwYXRoPiZyb3c9PG51bWJlcj4mY29sdW1uPTxudW1iZXI+XG4gIGNvbnN0IHBhcmFtcyA9IFsnZmlsZT0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHNvdXJjZSldXG4gIGlmIChzdGFydC5saW5lID4gMCkge1xuICAgIHBhcmFtcy5wdXNoKCdyb3c9JyArIChzdGFydC5saW5lIC0gMSkpXG4gICAgaWYgKHN0YXJ0LmNvbHVtbiA+IDApIHtcbiAgICAgIHBhcmFtcy5wdXNoKCdjb2x1bW49JyArIChzdGFydC5jb2x1bW4gLSAxKSlcbiAgICB9XG4gIH1cbiAgcmV0dXJuICdhdG9tOi8vbGludGVyPycgKyBwYXJhbXMuam9pbignJicpXG59XG5mdW5jdGlvbiBsaW50ZXJMaW5rKGxvYzogTG9jYXRpb24sIHRleHQ6IHN0cmluZykge1xuICByZXR1cm4gJ1snICsgdGV4dCArICddKCcgKyBmaWxlVXJsKGxvYykgKyAnKSdcbn1cbmZ1bmN0aW9uIGZpbGVMaW5rKGxvYzogTG9jYXRpb24pOiBzdHJpbmcge1xuICByZXR1cm4gbGludGVyTGluayhsb2MsIGF0b20ucHJvamVjdC5yZWxhdGl2aXplKGxvYy5zb3VyY2UpKVxufVxuZnVuY3Rpb24gbGluZUxpbmsobG9jOiBMb2NhdGlvbik6IHN0cmluZyB7XG4gIHJldHVybiBsaW50ZXJMaW5rKGxvYywgbG9jLnN0YXJ0LmxpbmUudG9TdHJpbmcoKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1haW5NZXNzYWdlT2ZFcnJvcihlcnJvcjogU3RhdHVzRXJyb3IpOiBTdGF0dXNNZXNzYWdlIHtcbiAgcmV0dXJuIGVycm9yLm9wZXJhdGlvbiB8fCBlcnJvci5tZXNzYWdlWzBdXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWluTG9jT2ZFcnJvcihlcnJvcjogU3RhdHVzRXJyb3IpOiA/TG9jYXRpb24ge1xuICByZXR1cm4gbWFpbk1lc3NhZ2VPZkVycm9yKGVycm9yKS5sb2Ncbn1cblxuZnVuY3Rpb24gZ2V0RXh0cmFNZXNzYWdlcyhleHRyYTogP1N0YXR1c0V4dHJhW10pOiBTdGF0dXNNZXNzYWdlW10ge1xuICBpZiAoZXh0cmEpIHtcbiAgICBjb25zdCBtZXNzYWdlcyA9IGV4dHJhLnJlZHVjZSgoYWNjLCBjdXJyZW50KSA9PiB7XG4gICAgICBjb25zdCBjaGlsZHJlbk1lc3NhZ2VzID0gZ2V0RXh0cmFNZXNzYWdlcyhjdXJyZW50LmNoaWxkcmVuKVxuICAgICAgcmV0dXJuIGFjYy5jb25jYXQoY3VycmVudC5tZXNzYWdlLCBjaGlsZHJlbk1lc3NhZ2VzKVxuICAgIH0sIFtdKVxuICAgIG1lc3NhZ2VzLmZvckVhY2goKG1lc3NhZ2UpID0+IHtcbiAgICAgIGNvbnN0IG1zZyA9IG1lc3NhZ2VcbiAgICAgIG1zZy5pbmRlbnQgPSAobXNnLmluZGVudCB8fCAwKSArIDJcbiAgICB9KVxuICAgIHJldHVybiBtZXNzYWdlc1xuICB9XG4gIHJldHVybiBbXVxufVxuXG5mdW5jdGlvbiBnZXRUcmFjZVJlYXNvbnModHJhY2U6ID9TdGF0dXNNZXNzYWdlW10pOiBTdGF0dXNNZXNzYWdlW10ge1xuICBpZiAodHJhY2UgIT0gbnVsbCAmJiB0cmFjZS5sZW5ndGggPiAwKSB7XG4gICAgcmV0dXJuIChbeyBkZXNjcjogJ1RyYWNlOicsIHR5cGU6ICdCbGFtZScgfV0uY29uY2F0KHRyYWNlKTogYW55KVxuICB9XG4gIHJldHVybiBbXVxufVxuXG5mdW5jdGlvbiBta0NvbW1lbnQoZGVzY3I6IHN0cmluZyk6IFN0YXR1c01lc3NhZ2Uge1xuICByZXR1cm4gKHsgZGVzY3IsIHR5cGU6ICdDb21tZW50JyB9OiBhbnkpXG59XG5cbmZ1bmN0aW9uIGdldE9wUmVhc29uKG9wOiA/U3RhdHVzTWVzc2FnZSk6IFN0YXR1c01lc3NhZ2VbXSB7XG4gIGlmIChvcCkge1xuICAgIHJldHVybiBbXG4gICAgICBvcCxcbiAgICAgIG1rQ29tbWVudCgnRXJyb3I6JyksXG4gICAgXVxuICB9XG4gIHJldHVybiBbXVxufVxuXG5mdW5jdGlvbiBnZXRIZWFkZXIobWFpbkxvYzogP0xvY2F0aW9uLCBraW5kOiBzdHJpbmcsIGxldmVsOiBzdHJpbmcpOiBTdGF0dXNNZXNzYWdlW10ge1xuICBsZXQgbGluZSA9IC0xXG4gIGxldCBmaWxlbmFtZSA9ICcnXG4gIGlmIChtYWluTG9jKSB7XG4gICAgY29uc3QgeyBzb3VyY2UsIHN0YXJ0IH0gPSBtYWluTG9jXG4gICAgbGluZSA9IHN0YXJ0LmxpbmVcbiAgICBpZiAoc291cmNlKSB7XG4gICAgICBmaWxlbmFtZSA9IGZpbGVMaW5rKG1haW5Mb2MpXG4gICAgfVxuICB9XG4gIGlmICghZmlsZW5hbWUpIHtcbiAgICBmaWxlbmFtZSA9IGZvcm1hdCgnJXM6JWQnLCAnW05vIGZpbGVdJywgbGluZSlcbiAgfVxuXG4gIGxldCBwcmVmaXggPSAnJ1xuICBpZiAoa2luZCA9PT0gJ2ludGVybmFsJyAmJiBsZXZlbCA9PT0gJ2Vycm9yJykge1xuICAgIHByZWZpeCA9ICdJbnRlcm5hbCBlcnJvciAoc2VlIGxvZ3MpOlxcbidcbiAgfSBlbHNlIGlmIChtYWluTG9jICYmIG1haW5Mb2MudHlwZSA9PT0gJ0xpYkZpbGUnKSB7XG4gICAgaWYgKGtpbmQgPT09ICdwYXJzZScgJiYgbGV2ZWwgPT09ICdlcnJvcicpIHtcbiAgICAgIHByZWZpeCA9ICdMaWJyYXJ5IHBhcnNlIGVycm9yOlxcbidcbiAgICB9IGVsc2UgaWYgKGtpbmQgPT09ICdpbmZlcicpIHtcbiAgICAgIHByZWZpeCA9ICdMaWJyYXJ5IHR5cGUgZXJyb3I6XFxuJ1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBbbWtDb21tZW50KGZvcm1hdCgnJXMlcycsIHByZWZpeCwgZmlsZW5hbWUpKV1cbn1cblxuZnVuY3Rpb24gcHJldHR5UHJpbnRNZXNzYWdlKG1haW5GaWxlOiBzdHJpbmcsIHsgY29udGV4dCwgZGVzY3IsIGxvYywgaW5kZW50IH06IFN0YXR1c01lc3NhZ2UpOiBzdHJpbmcge1xuICBjb25zdCBpbmRlbnRhdGlvbiA9ICcgJy5yZXBlYXQoaW5kZW50IHx8IDApXG4gIGlmIChsb2MpIHtcbiAgICBjb25zdCBzdGFydENvbCA9IGxvYy5zdGFydC5jb2x1bW4gLSAxXG4gICAgbGV0IGNvbnRleHRTdHIgPSBpbmRlbnRhdGlvblxuICAgIGlmIChjb250ZXh0ICE9PSBudWxsICYmIHR5cGVvZiBjb250ZXh0ID09PSAnc3RyaW5nJykge1xuICAgICAgLy8gT24gV2luZG93cyB0aGlzIG1pZ2h0IGhhdmUgXFxyXG4gICAgICBsZXQgY3R4ID0gY29udGV4dC50cmltUmlnaHQoKVxuICAgICAgLy8gUmVwbGFjZSB0YWJzIHdpdGggc3BhY2VzXG4gICAgICBjdHggPSBjdHgucmVwbGFjZSgvXFx0L2csICcgJylcbiAgICAgIC8vIGVzY2FwZSBjZXJ0YWluIGNoYXJzIHRoYXQgc2VydmUgYSBwdXJwb3NlIGluIG1hcmtkb3duXG4gICAgICBjdHggPSBjdHgucmVwbGFjZShyZWdleE1hcmtkb3duQ2hhcnMsICdcXFxcJCYnKVxuXG4gICAgICBjb25zdCB7IGxpbmUgfSA9IGxvYy5zdGFydFxuICAgICAgY29uc3QgcHJlZml4ID0gbGluZSA8IDEwMCA/ICcgJy5yZXBlYXQoMyAtIGxpbmUudG9TdHJpbmcoKS5sZW5ndGgpIDogJydcblxuICAgICAgbGV0IHBhZGRpbmcgPSBBcnJheSgocHJlZml4ICsgbGluZSArICc6ICcpLmxlbmd0aCArIDEpLmpvaW4oJyAnKVxuICAgICAgaWYgKGN0eC5sZW5ndGggPiBzdGFydENvbCkge1xuICAgICAgICBwYWRkaW5nICs9IGN0eC5zdWJzdHIoMCwgc3RhcnRDb2wpLnJlcGxhY2UoL1teXFx0IF0vZywgJyAnKVxuICAgICAgfVxuXG4gICAgICBjb25zdCB1bmRlcmxpbmVTaXplID0gbGluZSA9PT0gbG9jLmVuZC5saW5lID9cbiAgICAgICAgTWF0aC5tYXgoMSwgbG9jLmVuZC5jb2x1bW4gLSBzdGFydENvbCkgOlxuICAgICAgICAxXG4gICAgICBjb25zdCB1bmRlcmxpbmUgPSAnXicucmVwZWF0KHVuZGVybGluZVNpemUpXG5cbiAgICAgIGNvbnRleHRTdHIgPSBmb3JtYXQoXG4gICAgICAgICclcyVzJXM6ICVzXFxuJXMlcyVzICcsXG4gICAgICAgIGluZGVudGF0aW9uLFxuICAgICAgICBwcmVmaXgsXG4gICAgICAgIGxpbmVMaW5rKGxvYyksXG4gICAgICAgIGN0eCxcbiAgICAgICAgaW5kZW50YXRpb24sXG4gICAgICAgIHBhZGRpbmcsXG4gICAgICAgIHVuZGVybGluZSxcbiAgICAgIClcbiAgICB9XG4gICAgY29uc3Qgc2VlQW5vdGhlckZpbGUgPSBsb2Muc291cmNlID09PSBtYWluRmlsZSA/XG4gICAgICAnJyA6XG4gICAgICBmb3JtYXQoXG4gICAgICAgICcuIFNlZSVzOiAlcycsXG4gICAgICAgIGxvYy50eXBlID09PSAnTGliRmlsZScgPyAnIGxpYicgOiAnJyxcbiAgICAgICAgZmlsZUxpbmsobG9jKSxcbiAgICAgIClcbiAgICByZXR1cm4gZm9ybWF0KCclcyVzJXMnLCBjb250ZXh0U3RyLCBkZXNjciwgc2VlQW5vdGhlckZpbGUpXG4gIH1cbiAgcmV0dXJuIGluZGVudGF0aW9uICsgZGVzY3Jcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlZE1lc3NhZ2VzT2ZFcnJvcihlcnJvcjogU3RhdHVzRXJyb3IpOiBTdGF0dXNNZXNzYWdlW10ge1xuICBjb25zdCB7IGxldmVsLCBraW5kLCBtZXNzYWdlLCBvcGVyYXRpb24sIHRyYWNlLCBleHRyYSB9ID0gZXJyb3JcbiAgY29uc3QgbWFpbkxvYyA9IG1haW5Mb2NPZkVycm9yKGVycm9yKVxuICBjb25zdCBtZXNzYWdlcyA9IFtdLmNvbmNhdChcbiAgICBnZXRIZWFkZXIobWFpbkxvYywga2luZCwgbGV2ZWwpLFxuICAgIGdldE9wUmVhc29uKG9wZXJhdGlvbiksXG4gICAgbWVzc2FnZSxcbiAgICBnZXRFeHRyYU1lc3NhZ2VzKGV4dHJhKSxcbiAgICBnZXRUcmFjZVJlYXNvbnModHJhY2UpLFxuICApXG4gIC8vIE1lcmdlIGNvbW1lbnRzIGludG8gYmxhbWVzXG4gIHJldHVybiBtZXNzYWdlcy5yZWR1Y2UoKGFjYywgbXNnKSA9PiB7XG4gICAgY29uc3QgeyBkZXNjciwgbG9jLCB0eXBlIH0gPSBtc2dcbiAgICBpZiAobG9jIHx8IGFjYy5sZW5ndGggPT09IDAgfHwgdHlwZSA9PT0gJ0JsYW1lJykge1xuICAgICAgYWNjLnB1c2gobXNnKVxuICAgIH0gZWxzZSBpZiAoZGVzY3IgIT09ICdFcnJvcjonKSB7XG4gICAgICBjb25zdCBwcmV2ID0gYWNjW2FjYy5sZW5ndGggLSAxXVxuICAgICAgcHJldi5kZXNjciA9IHByZXYuZGVzY3IgPT09ICcnID8gZGVzY3IgOiBmb3JtYXQoJyVzLiAlcycsIHByZXYuZGVzY3IsIGRlc2NyKVxuICAgIH1cbiAgICByZXR1cm4gYWNjXG4gIH0sIFtdKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJldHR5UHJpbnRFcnJvcihlcnJvcjogU3RhdHVzRXJyb3IpOiBzdHJpbmcge1xuICBjb25zdCBtYWluTG9jID0gbWFpbkxvY09mRXJyb3IoZXJyb3IpXG4gIGNvbnN0IG1haW5GaWxlID0gKG1haW5Mb2MgJiYgbWFpbkxvYy5zb3VyY2UpIHx8ICdbTm8gZmlsZV0nXG4gIGNvbnN0IG1lc3NhZ2VzID0gbWVyZ2VkTWVzc2FnZXNPZkVycm9yKGVycm9yKVxuICByZXR1cm4gJzxkaXYgc3R5bGU9XCJ3aGl0ZS1zcGFjZTogcHJlLXdyYXBcIj4nICsgbWVzc2FnZXMubWFwKG1zZyA9PiBwcmV0dHlQcmludE1lc3NhZ2UobWFpbkZpbGUsIG1zZykpLmpvaW4oJ1xcbicpICsgJzwvZGl2Pidcbn1cbiJdfQ==