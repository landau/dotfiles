'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.JAVASCRIPT_WORD_REGEX = exports.JAVASCRIPT_WHOLE_STRING_IDENTIFIER_REGEX = exports.JAVASCRIPT_IDENTIFIER_REGEX = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; /**
                                                                                                                                                                                                                                                                   * Copyright (c) 2017-present, Facebook, Inc.
                                                                                                                                                                                                                                                                   * All rights reserved.
                                                                                                                                                                                                                                                                   *
                                                                                                                                                                                                                                                                   * This source code is licensed under the BSD-style license found in the
                                                                                                                                                                                                                                                                   * LICENSE file in the root directory of this source tree. An additional grant
                                                                                                                                                                                                                                                                   * of patent rights can be found in the PATENTS file in the same directory.
                                                                                                                                                                                                                                                                   *
                                                                                                                                                                                                                                                                   * 
                                                                                                                                                                                                                                                                   * @format
                                                                                                                                                                                                                                                                   */

exports.getReplacementPrefix = getReplacementPrefix;
exports.shouldFilter = shouldFilter;
exports.filterResultsByPrefix = filterResultsByPrefix;
exports.flowCoordsToAtomCoords = flowCoordsToAtomCoords;

var _simpleTextBuffer = require('simple-text-buffer');

var _fuzzaldrinPlus = require('fuzzaldrin-plus');

var _fuzzaldrinPlus2 = _interopRequireDefault(_fuzzaldrinPlus);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// A simple heuristic for identifier names in JavaScript.
const JAVASCRIPT_IDENTIFIER_REGEX = exports.JAVASCRIPT_IDENTIFIER_REGEX = /[$_a-zA-Z][$_\w]*/g;

const JAVASCRIPT_WHOLE_STRING_IDENTIFIER_REGEX = exports.JAVASCRIPT_WHOLE_STRING_IDENTIFIER_REGEX = /^[$_a-zA-Z][$_\w]*$/;

const identifierOrNumber = '[a-zA-Z0-9_$]+';

function makeStrRegex(delimiter) {
  const d = delimiter;
  // Each run of four backslashes ends up as just one backslash. We need to escape once for the
  // string literal here, and once for the RegExp compilation.
  return `${d}(\\\\.|[^${d}\\\\])*${d}`;
}

const strRegexes = ['`', "'", '"'].map(makeStrRegex);

const regexStrings = [].concat(strRegexes, [identifierOrNumber]).map(s => `(${s})`);

const JAVASCRIPT_WORD_REGEX = exports.JAVASCRIPT_WORD_REGEX = new RegExp(regexStrings.join('|'), 'g');

function getReplacementPrefix(originalPrefix) {
  // Ignore prefix unless it's an identifier (this keeps us from eating leading
  // dots, colons, etc).
  return JAVASCRIPT_WHOLE_STRING_IDENTIFIER_REGEX.test(originalPrefix) ? originalPrefix : '';
}

function shouldFilter(lastRequest, currentRequest, charsSinceLastRequest) {
  const prefixIsIdentifier = JAVASCRIPT_WHOLE_STRING_IDENTIFIER_REGEX.test(currentRequest.prefix);
  const previousPrefixIsDot = /^\s*\.\s*$/.test(lastRequest.prefix);
  const prefixLengthDifference = currentRequest.prefix.length - lastRequest.prefix.length;
  const startsWithPrevious = currentRequest.prefix.startsWith(lastRequest.prefix);

  return prefixIsIdentifier && (previousPrefixIsDot && currentRequest.prefix.length === charsSinceLastRequest || startsWithPrevious && prefixLengthDifference === charsSinceLastRequest);
}

function filterResultsByPrefix(prefix, results) {
  const replacementPrefix = getReplacementPrefix(prefix);
  const resultsWithCurrentPrefix = results.items.map(result => {
    return _extends({}, result, {
      replacementPrefix
    });
  });
  let items;
  // fuzzaldrin-plus filters everything when the query is empty.
  if (replacementPrefix === '') {
    items = resultsWithCurrentPrefix;
  } else {
    items = _fuzzaldrinPlus2.default.filter(resultsWithCurrentPrefix, replacementPrefix, {
      key: 'displayText'
    });
  }
  return _extends({}, results, { items });
}

function flowCoordsToAtomCoords(flowCoords) {
  return new _simpleTextBuffer.Range([flowCoords.start.line - 1, flowCoords.start.column - 1], [flowCoords.end.line - 1,
  // Yes, this is inconsistent. Yes, it works as expected in practice.
  flowCoords.end.column]);
}
//# sourceMappingURL=main.js.map