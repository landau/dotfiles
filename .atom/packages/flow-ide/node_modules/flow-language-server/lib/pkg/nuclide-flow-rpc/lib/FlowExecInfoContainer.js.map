{"version":3,"sources":["../../../../src/pkg/nuclide-flow-rpc/lib/FlowExecInfoContainer.js"],"names":["flowPath","root","result","cwd","undefined","toPromise","json","JSON","parse","flowVersion","semver","pathToFlow","binary","e","getFlowVersionInformation","process","platform","dirPath","dirname","whichPath","basename","canFindFlow","FLOW_BIN_PATH","FlowExecInfoContainer","constructor","versionInfo","_flowConfigDirCache","_flowExecInfoCache","max","maxAge","_disposables","_versionInfo","_observeSettings","dispose","reset","getFlowExecInfo","has","info","_computeFlowExecInfo","set","get","reallyGetFlowExecInfo","del","_getPathToFlow","execOptions","getFlowExecOptions","flowBinPath","_getFlowBinPath","systemFlowPath","_pathToFlow","cmdPath","_canUseFlowBin","join","findFlowConfigDir","localFile","getConfigDir","global","atom","add","config","observe","path","canUseFlowBin","env","OCAMLRUNPARAM"],"mappings":"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","file":"FlowExecInfoContainer.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n *\n * @flow\n * @format\n */\n\nimport type {LRUCache} from 'lru-cache';\n\nimport LRU from 'lru-cache';\nimport {CompositeDisposable} from 'event-kit';\n\nimport nuclideUri from 'nuclide-commons/nuclideUri';\nimport which from 'nuclide-commons/which';\nimport {runCommand} from 'nuclide-commons/process';\nimport {ConfigCache} from 'nuclide-commons/ConfigCache';\n\nconst FLOW_BIN_PATH = 'node_modules/.bin/flow';\n\ntype FlowVersionInfo = {\n  pathToFlow: string,\n  flowVersion: string,\n};\n\n// All the information needed to execute Flow in a given root. The path to the Flow binary we want\n// to use may vary per root -- for now, only if we are using the version of Flow from `flow-bin`.\n// The options also vary, right now only because they set the cwd to the current Flow root.\nexport type FlowExecInfo = {\n  pathToFlow: string,\n  flowVersion: string,\n  execOptions: Object,\n};\n\nexport class FlowExecInfoContainer {\n  // Map from file path to the closest ancestor directory containing a .flowconfig file (the file's\n  // Flow root)\n  _flowConfigDirCache: ConfigCache;\n\n  // Map from Flow root directory (or null for \"no root\" e.g. files outside of a Flow root, or\n  // unsaved files. Useful for outline view) to FlowExecInfo. A null value means that the Flow\n  // binary cannot be found for that root. It is possible for Flow to be available in some roots but\n  // not others because we will support root-specific installations of flow-bin.\n  _flowExecInfoCache: LRUCache<?string, ?FlowExecInfo>;\n\n  _disposables: CompositeDisposable;\n\n  _pathToFlow: string;\n  _canUseFlowBin: boolean;\n  _versionInfo: ?FlowVersionInfo;\n\n  constructor(versionInfo: ?FlowVersionInfo) {\n    this._flowConfigDirCache = new ConfigCache(['.flowconfig']);\n\n    this._flowExecInfoCache = LRU({\n      max: 10,\n      maxAge: 1000 * 30, // 30 seconds\n    });\n\n    this._disposables = new CompositeDisposable();\n    this._versionInfo = versionInfo;\n\n    this._observeSettings();\n  }\n\n  dispose() {\n    this._disposables.dispose();\n    this._flowConfigDirCache.dispose();\n    this._flowExecInfoCache.reset();\n  }\n\n  // Returns null iff Flow cannot be found.\n  async getFlowExecInfo(root: string | null): Promise<?FlowExecInfo> {\n    if (!this._flowExecInfoCache.has(root)) {\n      const info = await this._computeFlowExecInfo(root);\n      this._flowExecInfoCache.set(root, info);\n    }\n    return this._flowExecInfoCache.get(root);\n  }\n\n  reallyGetFlowExecInfo(root: string | null): Promise<?FlowExecInfo> {\n    this._flowExecInfoCache.del(root);\n    return this.getFlowExecInfo(root);\n  }\n\n  async _computeFlowExecInfo(root: string | null): Promise<?FlowExecInfo> {\n    let versionInfo;\n    if (this._versionInfo == null) {\n      const flowPath = await this._getPathToFlow(root);\n      if (flowPath == null) {\n        return null;\n      }\n      versionInfo = await getFlowVersionInformation(flowPath, root);\n      if (versionInfo == null) {\n        return null;\n      }\n    } else {\n      versionInfo = this._versionInfo;\n    }\n\n    return {\n      ...versionInfo,\n      execOptions: getFlowExecOptions(root),\n    };\n  }\n\n  // Return the path we should use to execute Flow for the given root, or null if Flow cannot be\n  // found.\n  async _getPathToFlow(root: string | null): Promise<?string> {\n    const flowBinPath = await this._getFlowBinPath(root);\n    if (flowBinPath != null && (await canFindFlow(flowBinPath))) {\n      return flowBinPath;\n    }\n\n    // Pull this into a local on the off chance that the setting changes while we are doing the\n    // check.\n    const systemFlowPath = this._pathToFlow;\n\n    // If on Windows, prefer the .cmd wrapper for flow if it's available.\n    if (process.platform === 'win32') {\n      const cmdPath = systemFlowPath + '.cmd';\n      if (await canFindFlow(systemFlowPath)) {\n        return cmdPath;\n      }\n    }\n\n    if (await canFindFlow(systemFlowPath)) {\n      return systemFlowPath;\n    }\n\n    return null;\n  }\n\n  async _getFlowBinPath(root: string | null): Promise<?string> {\n    if (root == null) {\n      return null;\n    }\n    if (!this._canUseFlowBin) {\n      return null;\n    }\n    // If we are running on Windows, we should use the .cmd version of flow.\n    if (process.platform === 'win32') {\n      return nuclideUri.join(root, FLOW_BIN_PATH + '.cmd');\n    }\n    return nuclideUri.join(root, FLOW_BIN_PATH);\n  }\n\n  async findFlowConfigDir(localFile: string): Promise<?string> {\n    return this._flowConfigDirCache.getConfigDir(localFile);\n  }\n\n  _observeSettings(): void {\n    if (global.atom == null) {\n      this._pathToFlow = 'flow';\n      this._canUseFlowBin = false;\n    } else {\n      // $UPFixMe: This should use nuclide-features-config\n      // Does not currently do so because this is an npm module that may run on the server.\n      this._disposables.add(\n        atom.config.observe('nuclide.nuclide-flow.pathToFlow', path => {\n          this._pathToFlow = path;\n          this._flowExecInfoCache.reset();\n        }),\n        atom.config.observe(\n          'nuclide.nuclide-flow.canUseFlowBin',\n          canUseFlowBin => {\n            this._canUseFlowBin = canUseFlowBin;\n            this._flowExecInfoCache.reset();\n          },\n        ),\n      );\n    }\n  }\n}\n\nasync function getFlowVersionInformation(\n  flowPath: string,\n  root: string | null,\n): Promise<?{flowVersion: string, pathToFlow: string}> {\n  try {\n    const result = await runCommand(\n      flowPath,\n      ['version', '--json'],\n      root != null ? {cwd: root} : undefined,\n    ).toPromise();\n    const json = JSON.parse(result);\n    return {\n      flowVersion: json.semver,\n      pathToFlow: json.binary,\n    };\n  } catch (e) {\n    return null;\n  }\n}\n\nasync function canFindFlow(flowPath: string): Promise<boolean> {\n  if (process.platform === 'win32') {\n    // On Windows, if the flow path is configured as a full path rather than just \"flow\" or\n    // \"flow.exe\", format the path correctly to pass to `where <flow>`\n    const dirPath = nuclideUri.dirname(flowPath);\n    if (dirPath != null && dirPath !== '' && dirPath !== '.') {\n      const whichPath = `${nuclideUri.dirname(flowPath)}:${nuclideUri.basename(\n        flowPath,\n      )}`;\n      return (await which(whichPath)) != null;\n    }\n  }\n\n  return (await which(flowPath)) != null;\n}\n\n// `string | null` forces the presence of an explicit argument (`?string` allows undefined which\n// means the argument can be left off altogether.\nfunction getFlowExecOptions(root: string | null): Object {\n  return {\n    cwd: root,\n    env: {\n      // Allows backtrace to be printed:\n      // http://caml.inria.fr/pub/docs/manual-ocaml/runtime.html#sec279\n      OCAMLRUNPARAM: 'b',\n      // Put this after so that if the user already has something set for OCAMLRUNPARAM we use\n      // that instead. They probably know what they're doing.\n      ...process.env,\n    },\n  };\n}\n"]}